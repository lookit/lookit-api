{% load django_bootstrap5 %}
<script>

    // Show the generator function field only if use_generator is checked.
    function updateGeneratorDisplay() {
        if ($('#id_use_generator:checked').length) {
            $('#generator-container').show();
        } else {
            $('#generator-container').hide();
        }
    }

    // Display an error if generator is not a valid JS function. Returns 0 if no errors, 1 if errors.
    function validateGenerator(code) {

        const $errorToDisplay = $('<div id="clientside-generator-validation-message" class="help-block"></div>');
        const $generatorField = $('#id_generator').closest('.mb-4');
        $generatorField.removeClass('has-error');
        $('#clientside-generator-validation-message').remove();

        try {
            Function(code)();
            try {
                const generatorFn = Function('return ' + code)();
                if (typeof generatorFn !== 'function') {
                    throw new Error();
                }
            } catch (error) {
                $errorToDisplay
                    .text('Warning: Generator function does not evaluate to a single function. Generator will be disabled if this value is saved.')
                    .insertBefore($generatorField.children().last());
                $generatorField.addClass('has-error');
                return 1;
            }
        } catch (error) {
            $errorToDisplay
                .text('Warning: Invalid Javascript. Generator will be disabled if this value is saved.')
                .insertBefore($generatorField.children().last());
            $generatorField.addClass('has-error');
            return 1;
        }
        return 0;
    }

    // Display an error if structure is not a valid JSON string. Returns 0 if no errors, 1 if errors.
    function validateStructure(code) {
        const $errorToDisplay = $('<div id="clientside-protocol-validation-message" class="help-block"></div>');
        const $protocolField = $('#id_structure').closest('.mb-4');
        $protocolField.removeClass('has-error');
        $('#clientside-protocol-validation-message').remove();
        try {
            JSON.parse(code);
        } catch (error) {
            $errorToDisplay
                .text('Warning: Invalid JSON.')
                .insertBefore($protocolField.children().last());
            $protocolField.addClass('has-error');
            return 1;
        }
        return 0;
    }

    // Update a read-only field to display the calculated max age in days
    function updateMaxAgeDaysDisplay() {
        $("#max_age_in_days_val").text(Number($("#id_max_age_years").val()) * 365 + Number($("#id_max_age_months").val()) * 30 + Number($("#id_max_age_days").val()))
    }

    // Update a read-only field to display the calculated min age in days
    function updateMinAgeDaysDisplay() {
        $("#min_age_in_days_val").text(Number($("#id_min_age_years").val()) * 365 + Number($("#id_min_age_months").val()) * 30 + Number($("#id_min_age_days").val()))
    }

    function setExternal() {
            // hide frame player fields through css                
            document
                .querySelectorAll('#type-metadata-1, #structure-container, #generator-container, .use-generator.help-block')
                .forEach(e => e.classList.add('d-none'))
            // disable frame player metadata fields
            document
                .querySelectorAll("#type-metadata-1 input")
                .forEach(e => e.disabled=true)
            // enable external fields
            document
                .querySelectorAll("#type-metadata-2 input")
                .forEach(e => e.disabled=false)
            document.querySelector('#generator-container').classList.add('d-none')
            document.querySelector('#type-metadata-2').classList.remove('d-none')
        }

    function setFramePlayer() {
            // hide external fields through css
            document
                .querySelectorAll('#type-metadata-1, #structure-container, #generator-container, .use-generator.help-block')
                .forEach(e => e.classList.remove('d-none'))
            // enable frame player metadata fields
            document
                .querySelectorAll("#type-metadata-1 input")
                .forEach(e => e.disabled=false)
            // disable external fields
            document
                .querySelectorAll("#type-metadata-2 input")
                .forEach(e => e.disabled=true)
            document.querySelector('#generator-container').classList.remove('d-none')
            document.querySelector('#type-metadata-2').classList.add('d-none')
        }

    function updateStudyType (externalCheckbox) {
        externalCheckbox.checked ? setExternal() : setFramePlayer()
        updateScheduled()
    }

    function updateScheduled(){
        const external = document.querySelector('#id_external')
        const scheduled = document.querySelector('#id_scheduled')
        scheduled.disabled = !external.checked
    }

    function updateScheduling (scheduledCheckBox) {            
        const scheduling = document.querySelector("#id_scheduling").closest('.mb-4')
        if (!scheduledCheckBox.disabled && scheduledCheckBox.checked){
            scheduling.classList.remove("d-none")
        } else {
            scheduling.classList.add("d-none")
        }
    }

    $(document).ready(function() {
        // Do initial validation of structure, generator.
        validateStructure($('#id_structure').val());
        validateGenerator($('#id_generator').val());

        // When use_generator field changes, update whether generator field is displayed
        updateGeneratorDisplay();
        $('#id_use_generator').on('change', function() {
            updateGeneratorDisplay();
        });

        // Validate generator function upon closing its editor
        $("#generator-container .ace-overlay .save, #generator-container .ace-overlay .cancel").bind("click", function () {
            // data field 'editor' bound to editor but only while editor is open
            const code = $('#generator-container .ace-overlay').data('editor').getValue();
            validateGenerator(code);
        });

        // Validate structure function upon closing its editor
        $("#structure-container .ace-overlay .save, #generator-container .ace-overlay .cancel").bind("click", function () {
            // data field 'editor' bound to editor but only while editor is open
            const code = $('#structure-container .ace-overlay').data('editor').getValue();
            validateStructure(code);
        });

        // Use ctrl-S to close editor from either editor.
        $(".ace-overlay .edit").bind("click", function () {
            const $aceOverlay = $(this).closest('.ace-overlay')
            const editor = $aceOverlay.data('editor');
            editor.commands.addCommand({
                name: 'save',
                bindKey: {win: 'Ctrl-S', mac: 'Command-S'},
                exec: function() {
                    $aceOverlay.find('.save').click();
                    // Could also consider triggering save button on broader form
                },
                readOnly: false // should not apply in readOnly mode
            });
        });

        // Upon submit, unset use generator if generator function is invalid
        $("#create-study-button, #save-button").bind("click", function() {
            if (validateGenerator($('#id_generator').val())) {
                const $useGeneratorCheckbox = $('#id_use_generator');
                $useGeneratorCheckbox.prop("checked", false);
                $useGeneratorCheckbox[0].value = false;
            }
        });

        // Calculate the min/max age in day(s) upon page load & updates
        $("#id_min_age_years, #id_min_age_months, #id_min_age_days").change(updateMinAgeDaysDisplay);
        $("#id_max_age_years, #id_max_age_months, #id_max_age_days").change(updateMaxAgeDaysDisplay);
        updateMinAgeDaysDisplay();
        updateMaxAgeDaysDisplay();

        // Update study form based on study type
        const externalCheckbox = document.querySelector('#id_external')
        externalCheckbox.addEventListener('click', () => updateStudyType(externalCheckbox))
        updateStudyType(externalCheckbox)
        
        const scheduledCheckBox = document.querySelector("#id_scheduled")
        scheduledCheckBox.addEventListener('click', ()=>{
            updateScheduling(scheduledCheckBox)
        })
        updateScheduling(scheduledCheckBox)

        /*
            Priority current value
        */

        const priority = document.querySelector('#id_priority');
        const currentPriority = document.createElement('div');
        const priorityParent = priority.parentElement;
        const highest = document.createElement('span');
        const lowest = document.createElement('span');
        const helpBlock = priorityParent.querySelector('.form-text'); // should be .help-block but I don't know how to apply this class to the priority help text

        // Add current priority element
        currentPriority.id = 'current-priority';
        priorityParent.insertBefore(currentPriority, priority);

        // Add priority labels
        highest.innerHTML = 'Highest';
        lowest.innerHTML = 'Lowest';
        highest.classList.add('priority-highest');
        priorityParent.insertBefore(lowest, helpBlock);
        priorityParent.insertBefore(highest, helpBlock);
        

        // Event listener to update current priority value
        priority.addEventListener('input', ()=>{currentPriority.innerHTML = `Current Priority: ${priority.value}`});
        
        // Call input event one time to populate current priority element
        priority.dispatchEvent(new Event('input'));

        /*
            Participation Selection 
        */

        const mustHaveList = document.createElement('ul');
        const mustNotHaveList = document.createElement('ul');
        const mustHave = document.querySelector('#id_must_have_participated');
        const mustNotHave = document.querySelector('#id_must_not_have_participated');
        const mustHaveDiv = document.createElement('div');
        const mustNotHaveDiv = document.createElement('div');

        // List headers
        mustHaveDiv.innerHTML = 'Participants must have participated in:';
        mustNotHaveDiv.innerHTML = 'Participants must NOT have participated in:';
        mustHave.parentElement.append(mustHaveDiv, mustHaveList);
        mustNotHave.parentElement.append(mustNotHaveDiv, mustNotHaveList);

        // Update list with current selection.  Hide header when list empty. 
        function showSelectedStudies(select, ul, div){
            const selection = select.querySelectorAll('option:checked');
            ul.children && [...ul.children].forEach(e=>e.remove());
            selection.forEach(e => {
                const li = document.createElement('li');
                li.innerHTML = e.innerHTML;
                ul.append(li);
            });
            ul.children.length ? div.classList.remove('d-none') : div.classList.add('d-none');
        }

        // Augment default mousedown event for multi select.  Option is selected when clicked and 
        // unselected when clicked again. 
        function toggleSelection(el){
            el.addEventListener('mousedown', (event) => {
                event.preventDefault();
                // Adjust selection when element has focus.
                if (document.activeElement === el.parentElement){
                    el.selected = !el.selected
                }
                el.parentElement.focus();
            });
        }

        // add event listeners to select and options.
        mustHave.addEventListener('mousedown', ()=>{showSelectedStudies(mustHave, mustHaveList, mustHaveDiv);});
        mustNotHave.addEventListener('mousedown', ()=>{showSelectedStudies(mustNotHave, mustNotHaveList, mustNotHaveDiv);});
        [...mustHave.options, ...mustNotHave.options].forEach(el => toggleSelection(el));

        // Trigger mousedown to populate ui.
        mustHave.dispatchEvent(new Event('mousedown'));
        mustNotHave.dispatchEvent(new Event('mousedown'));

    });
</script>
<style>
    #study-details-form .ace-overlay,
    #study-create-form .ace-overlay {
        width: 100%;
        margin-bottom: 1.5rem;
    }

    #structure-container .code-container,
    #generator-container .code-container {
        max-height: 10em;
    }

    span.priority-highest {
        float: right;
    }
</style>
{% bootstrap_form_errors form %}
{% bootstrap_field form.name label_class='form-label fw-bold' wrapper_class="mb-4" %}
{% bootstrap_field form.lab label_class='form-label fw-bold' wrapper_class="mb-4" %}
{% bootstrap_field form.priority label_class='form-label fw-bold' wrapper_class="mb-4" addon_before="" %}
<hr />
<div class="row">
    <div class="col-xs-12 mb-4">
        <label class="form-label fw-bold">Study Type</label>
        <p>
            Choose what type of study you are creating - this will change the fields that appear in the Experiment Details section.
        </p>
        {% bootstrap_field form.external %}
        {% bootstrap_field form.scheduled wrapper_class="" %}
    </div>
</div>
<hr />
<div class="row">
    <div class="col-xs-12 mb-4">
        <label class="form-label fw-bold">"Studies" Card and Study Detail Page</label>
        <p>
            Add details about your study and how it should be displayed on Lookit
        </p>
        {% bootstrap_field form.public %}
        {% bootstrap_field form.shared_preview wrapper_class="" %}
    </div>
</div>
{% bootstrap_field form.image label_class="form-label fw-bold" wrapper_class="mb-4" %}
{% bootstrap_field form.preview_summary label_class="form-label fw-bold" wrapper_class="mb-4" %}
{% bootstrap_field form.short_description label_class="form-label fw-bold" wrapper_class="mb-4" %}
{% bootstrap_field form.purpose label_class="form-label fw-bold" wrapper_class="mb-4" %}
{% bootstrap_field form.compensation_description label_class="form-label fw-bold" wrapper_class="mb-4" %}
{% bootstrap_field form.exit_url label_class="form-label fw-bold" wrapper_class="mb-4" %}
{% bootstrap_field form.criteria label_class="form-label fw-bold" wrapper_class="mb-4" %}
{% bootstrap_field form.duration label_class="form-label fw-bold" wrapper_class="mb-4" %}
{% bootstrap_field form.contact_info label_class="form-label fw-bold" wrapper_class="mb-4" %}
<hr />
<div class="row">
    <div class="col-xs-12">
        <label class="form-label fw-bold">Eligibility</label>
        <p>
            Choose the criteria used to determine if a child is currently eligible for a study. First set the age range and any restrictions on previous studies. Then you can add any additional rules for eligibility. Please visit our
            <a href="https://lookit.readthedocs.io/en/develop/researchers-set-study-fields.html#criteria-expression">documentation</a>
            for more details on how study eligibility works.
        </p>
    </div>
</div>
<div class="row justify-content-start">
    <div class="col-xs-12">
        <label class="form-label fw-bold">Minimum Age Cutoff</label>
    </div>
    <div class="col-2">
        <div class="mb-4">
            <label class="form-label" for="id_min_age_years">
                <em>Years</em>
            </label>
            <select name="min_age_years"
                    class="form-control form-select"
                    title=""
                    id="id_min_age_years">
                {% for x, y in form.fields.min_age_years.choices %}
                    <option value="{{ x }}" {% if study.min_age_years == x %} selected{% endif %}>
                        {{ y }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="col-2">
        <div class="mb-4">
            <label class="form-label" for="id_min_age_months">
                <em>Months</em>
            </label>
            <select class="form-control form-select"
                    id="id_min_age_months"
                    name="min_age_months"
                    title="">
                {% for x, y in form.fields.min_age_months.choices %}
                    <option value="{{ x }}"{% if study.min_age_months == x %} selected{% endif %}>
                        {{ y }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="col-2">
        <div class="mb-4">
            <label class="form-label" for="id_min_age_days">
                <em>Days</em>
            </label>
            <select class="form-control form-select"
                    id="id_min_age_days"
                    name="min_age_days"
                    title="">
                {% for x, y in form.fields.min_age_days.choices %}
                    <option value="{{ x }}" {% if study.min_age_days == x %} selected{% endif %}>
                        {{ y }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="col-2">
        <label class="form-label" for="min_age_in_days">
            <em>Age in Days</em>
        </label>
        <div><span class="help-block" id="min_age_in_days_val">0</span></div>
    </div>
</div>
<div class="row justify-content-start">
    <div class="col-xs-12">
        <label class="form-label fw-bold">Maximum Age Cutoff</label>
    </div>
    <div class="col-2">
        <div class="mb-4">
            <label class="form-label" for="id_max_age_years">
                <em>Years</em>
            </label>
            <select name="max_age_years"
                    class="form-control form-select"
                    title=""
                    id="id_max_age_years">
                {% for x, y in form.fields.max_age_years.choices %}
                    <option value="{{ x }}" {% if study.max_age_years == x %} selected{% endif %}>
                        {{ y }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="col-2">
        <div class="mb-4">
            <label class="form-label" for="id_max_age_months">
                <em>Months</em>
            </label>
            <select class="form-control form-select"
                    id="id_max_age_months"
                    name="max_age_months"
                    title="">
                {% for x, y in form.fields.max_age_months.choices %}
                    <option value="{{ x }}"
                            {% if study.max_age_months == x %} selected{% endif %}>
                        {{ y }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="col-2">
        <div class="mb-4">
            <label class="form-label" for="id_max_age_days">
                <em>Days</em>
            </label>
            <select class="form-control form-select"
                    id="id_max_age_days"
                    name="max_age_days"
                    title="">
                {% for x, y in form.fields.max_age_days.choices %}
                    <option value="{{ x }}" {% if study.max_age_days == x %} selected{% endif %}>
                        {{ y }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="col-2">
        <label class="form-label" for="max_age_in_days">
            <em>Age in Days</em>
        </label>
        <div><span class="help-block" id="max_age_in_days_val">0</span></div>
    </div>
</div>
<p class="help-block text-muted">
    Families who select a child outside the age range see a warning indicating that their data may not be used. The child's age in days is compared to these (inclusive) min and max ages (computed as years * 365 + months * 30 + days) to check eligibility.
</p>
{% bootstrap_field form.must_have_participated label_class="form-label fw-bold" wrapper_class="mb-4" %}
{% bootstrap_field form.must_not_have_participated label_class="form-label fw-bold" wrapper_class="mb-4" %}
{% bootstrap_field form.criteria_expression label_class="form-label fw-bold" wrapper_class="mb-4" %}
<hr />
<div class="row">
    <div class="col-xs-12">
        <label class="form-label fw-bold">Experiment Details</label>
        <p>
            Now it's time for the actual study! For internal studies, you will add a protocol configuration or generator. For external studies, you will paste in your study or scheduling link. If you don't see what you expect, check the "External" and "Scheduled" checkboxes at the top of this form!
        </p>
    </div>
</div>
<div id="structure-container">{% bootstrap_field form.structure label_class="form-label fw-bold" %}</div>
{% bootstrap_field form.use_generator label_class="form-label" wrapper_class="" %}
<div class="use-generator help-block text-muted form-text mb-4">{{ form.generator.help_text|safe }}</div>
<div id="generator-container">{% bootstrap_field form.generator show_help=False label_class="form-label fw-bold" %}</div>
