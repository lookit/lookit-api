{% load exp_extras %}
{% load django_bootstrap5 %}
{% load bootstrap_icons %}
{% load static %}
<script src="{% static 'js/study-type.js' %}" defer></script>
<div id="study-type-metadata">
    <div class="row">
        <div class="col-xs-12">
            {% for study_type in study_types %}
                <div class="type-fields" id="type-metadata-{{ study_type.id }}">
                    {% for field in study_type.configuration.metadata.fields %}
                        {% with field.name as key %}
                            {% with field.value as value %}
                                {% with key_help_text|get_key:key|default:"" as help_text %}
                                    {% if field.input_type == "checkbox" %}
                                        <div class="mb-4"
                                             data-previous='{% if not create %}{{ study.metadata|get_key:key|default:"" }}{% endif %}'>
                                            <input name="{{ key }}"
                                                   type="{{ field.input_type }}"
                                                   {% if study and study.metadata|get_key:key %}checked{% endif %}/>
                                            <label class="form-label fw-bold">{{ key_display_names|get_key:key|default:key }}</label>
                                        </div>
                                    {% elif field.input_type == "radio" %}
                                        <div class="mb-4">
                                            <label id="id_{{ field.name }}"
                                                   class="form-label fw-bold"
                                                   title="{{ help_text }}">
                                                {{ key_display_names|get_key:key|default:key }}
                                            </label>
                                            {% for option in field.options %}
                                                <div class="radio">
                                                    <label>
                                                        <input name="{{ field.name }}"
                                                               value="{{ option }}"
                                                               type="radio"
                                                               {% if study and study.metadata|get_key:key == option %}checked{% endif %}/>
                                                        {{ option }}
                                                    </label>
                                                </div>
                                                {% if option == "Other" %}
                                                    {% if study %}
                                                        {% with "other_"|add:field.name as other_field %}
                                                            {% with study.metadata|get_key:other_field|default:'' as other_value %}
                                                                <input class="form-control d-none"
                                                                       type="text"
                                                                       name="other_{{ field.name }}"
                                                                       value="{{ other_value }}"/>
                                                            {% endwith %}
                                                        {% endwith %}
                                                    {% else %}
                                                        <input class="form-control d-none" type="text" name="other_{{ field.name }}"/>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                            <div class="help-block">{{ help_text }}</div>
                                        </div>
                                    {% else %}
                                        <div class="mb-4 metadata-key"
                                             data-previous='{% if not create %}{{ study.metadata|get_key:key|default:"" }}{% endif %}'>
                                            <label class="form-label fw-bold">{{ key_display_names|get_key:key|default:key }}</label>
                                            <div class="input-container">
                                                <input class="form-control"
                                                       title="{{ help_text }}"
                                                       name="{{ key }}"
                                                       type="{{ field.input_type }}"
                                                       value="{% if study_type.id == currentType and not create %}{{ study.metadata|get_key:key|default:'' }}{% else %}{{ value | default:'' }}{% endif %}"/>
                                            </div>
                                            <div class="help-block">{{ help_text }}</div>
                                        </div>
                                    {% endif %}
                                    {% if key == "last_known_player_sha" %}
                                        <div id="commit-description" class="card bg-light my-4">
                                            <div class="card-header">
                                                <h3 class="card-subtitle my-1">
                                                    About this version
                                                    <div class="float-end me-4">
                                                        {% bootstrap_button "Check for updates" button_class="btn btn-light link-secondary border-secondary" id="update-button" %}
                                                    </div>
                                                </h3>
                                            </div>
                                            <div class="card-body"></div>
                                        </div>
                                        <div id="commit-update-info" class="card bg-light my-4">
                                            <div class="card-header">
                                                <h3 class="card-subtitle my-1">
                                                    Update info
                                                </h3>
                                            </div>
                                            <div class="card-body"></div>
                                        </div>
                                    {% endif %}
                                {% endwith %}
                            {% endwith %}
                        {% endwith %}
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
    </div>
</div>
