{% extends "exp/base.html" %}
{% load django_bootstrap5 %}
{% load bootstrap_icons %}
{% load guardian_tags %}
{% load exp_extras %}
{% load bootstrap_icons %}
{% block head %}
    {{ block.super }}
    <script type="application/javascript">
        /* Fix for ace-editor. It thinks it's in the admin only */
        (function () {
            if (window.jQuery !== undefined) {
                window.django = {
                    'jQuery': window.jQuery
                };
            }
        })();
    </script>
    <script>
        $(document).ready(function () {
            $('#invalidate-build-warning').hide();
            $('#save-button').click(function() {
                var runner_type_changed = ($('#id_study_type').data('previous') != $('#id_study_type').val());
                $('#study-type-metadata div.metadata-key').each(function( index, element) {
                    runner_type_changed = runner_type_changed || ($(element).data('previous') != $('input', element).val());
                })
                if (runner_type_changed) {
                    $('#invalidate-build-warning').show();
                }
            });
        });
    </script>
    {{ form.media }}
{% endblock head %}
{% block title %}
    Edit | {{ study.name }}
{% endblock title %}
{% block flash %}
    {% if messages %}
        {% for message in messages %}
            {% if message.extra_tags != 'user_added' and message.extra_tags != 'user_removed' %}
                <div id="details" class="alert {{ message.tags }} alert-dismissable">
                    <a href="#" class="close" data-dismiss="alert" aria-label="close">×</a>
                    {{ message }}
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}
{% endblock flash %}
{% block content %}
    {% bs_icon "play-circle" as bs_icon_play_circle %}
    {% url 'exp:preview-detail' uuid=study.uuid as url_preview_detail %}
    {% url 'exp:study-edit' pk=study.id as url_cancel %}
    <div class="container">
        <div class="row">
            <div class="col-xs-12">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'exp:study-list' %}">Manage Studies</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'exp:study-detail' pk=study.id %}">{{ study.name }}</a>
                    </li>
                    <li class="breadcrumb-item active">Edit</li>
                </ol>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-10 offset-lg-1">
                <div class="card bg-light my-4">
                    <div class="card-header">
                        <h3 class="card-subtitle my-1">
                            Study Editor
                            <div class="float-end me-4">
                                {% bootstrap_button bs_icon_play_circle|add:"Preview Study" href=url_preview_detail button_class="btn btn-light link-secondary border-secondary" %}
                            </div>
                        </h3>
                    </div>
                    <div class="card-body">
                        <form id="study-details-form" enctype="multipart/form-data" method="post">
                            {% csrf_token %}
                            {% include "studies/_study_fields.html" with form=form study=study %}
                            {% include "studies/_study_type.html" with types=types create=0 currentType=study.study_type.id %}
                            <div class="me-4 float-end">
                                {% bootstrap_button "Cancel" button_class="btn btn-light link-secondary border-secondary" href=url_cancel %}
                                {% bootstrap_button "Save Changes" button_class="btn-success" href="#save-study-confirmation" id="save-button" data_toggle="modal" %}
                            </div>
                            <div class="modal fade" id="save-study-confirmation">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal">×</button>
                                        <h3>Are you sure you want to modify {{ study.name }}?</h3>
                                    </div>
                                    {% if study.built or save_confirmation %}
                                        <div class="modal-body">
                                            {% if study.built %}
                                                <p id="invalidate-build-warning">
                                                    You have already built an experiment runner!
                                                    Because you are changing the runner version, you will need to rebuild these
                                                    before you can preview or start your study.
                                                </p>
                                            {% endif %}
                                            {% if save_confirmation %}
                                                <p>
                                                    This study has already been
                                                    <strong>approved</strong>
                                                    . If you edit this study, the system will
                                                    automatically give it a rejected status. You will have to resubmit
                                                    the study so your changes can be reviewed.
                                                </p>
                                                <p>
                                                    If your changes are limited to
                                                    <ul>
                                                        <li>whether the study is discoverable</li>
                                                        <li>whether the preview is shared</li>
                                                        <li>the minimum and maximum age or criteria expression</li>
                                                        <li>the participant eligibility description</li>
                                                        <li>
                                                            the
                                                            <em>formatting</em>
                                                            of your study protocol
                                                        </li>
                                                    </ul>
                                                    then your study will stay in its {{ study.state }} state.
                                                </p>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    <div class="modal-footer">
                                        <a class="btn btn-light link-secondary border-secondary" href="{% url 'exp:study-edit' pk=study.id %}">Discard Changes</a>
                                        <button id="save_study_details_confirm" type="submit" class="btn btn-danger">Save</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}