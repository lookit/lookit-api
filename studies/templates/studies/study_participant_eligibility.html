{% extends 'exp/base.html' %}
{% load bootstrap3 %}
{% load exp_extras %}

{% block title %}Participant Eligibility | {{ eligible_participant_query_model.study }} {% endblock %}
{% block head %}
    {{ block.super }}
    {# NoUI Slider #}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.0.2/nouislider.min.js" integrity="sha256-VG+4f1Hm2q4e+DTEOaiZKlWjJm5W4yqnXNvKkWBYA20=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.0.2/nouislider.min.css" integrity="sha256-6pa9Ln4B/FyHlxOYaXuwpET9xH0e21iX0SPLg9P5Ro0=" crossorigin="anonymous"/>

    {# Bootstrap Toggle -- keeping here in case it is needed later #}
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>

    {# Moment #}
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>

    {# Filtrex #}
    <script src="https://rawgit.com/joewalnes/filtrex/master/filtrex.js"></script>

{% endblock %}

{% block flash %}
    {% bootstrap_messages %}
    {% if form.non_field_errors %}
        <div class="alert alert-danger" role="alert">
            {{ form.non_field_errors }}
        </div>
    {% endif %}
{% endblock %}

{% block content %}
    <div class="container mb-lg">
        <div class="row">
            <div class="col-xs-12">
                <ol class="breadcrumb">
                    <li><a href="{% url 'exp:study-list' %}">Manage Studies</a></li>
                    <li>
                        <a href="{% url 'exp:study-detail' pk=eligible_participant_query_model.study.id %}">
                            {{ eligible_participant_query_model.study.name }}
                        </a>
                    </li>
                    <li class="active">Participant Eligibility</li>
                </ol>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-10 col-lg-offset-1">
                <div class="panel panel-default mt-xl">
                    <div class="panel-heading">
                        <h1 class="panel-title">Edit Participant Eligibility</h1>
                    </div>
                    <div class="panel-body">
                        <h3>Current Eligibility Criteria</h3>
                        <div class="well well-sm">
                            <dl class="dl-horizontal">
                                <dt>Gestational Age at Birth</dt>
                                <dd id="gestational-age-summary">
                                    Born between <em>{{ object.get_gestational_age_start_display }}</em>
                                    and <em>{{ object.get_gestational_age_end_display }}</em>
                                    ({% if not object.gestational_age_include_na %}don't {% endif %}include N/A)
                                </dd>
                                <dt>Age Range</dt>
                                <dd id="age-range-summary">
                                    Between <em>{{ object.age_range_start_years }}</em> years,
                                    <em>{{ object.age_range_start_months }}</em> months,
                                    <em>{{ object.age_range_start_days }}</em> days old
                                    and <em>{{ object.age_range_end_years }}</em> years,
                                    <em>{{ object.age_range_end_months }}</em> months, and
                                    <em>{{ object.age_range_end_days}}</em> days old
                                </dd>
                                <dt>Gender Specification</dt>
                                <dd id="gender-specification-summary">
                                    <em>{{ object.get_gender_specification_display|default_if_none:"Doesn't matter" }}</em>
                                </dd>
                                <dt>Characteristics</dt>
                                <dd id="characteristics-summary">
                                    {% if object.require_conditions.mask == 0 %}
                                        <p>No required characteristics/conditions.</p>
                                    {% else %}
                                        Require:
                                        <ul>
                                            {% for bit in object.require_conditions %}
                                                {% bit_is_set object.require_conditions forloop.counter0 as show_bit %}
                                                {% if show_bit %}
                                                    <li>{% get_bit_label object.require_conditions forloop.counter0 %}</li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                    {% if object.exclude_conditions.mask == 0 %}
                                        <p>No excluded characteristics/conditions.</p>
                                    {% else %}
                                        Exclude:
                                        <ul>
                                            {% for bit in object.exclude_conditions %}
                                                {% bit_is_set object.exclude_conditions forloop.counter0 as show_bit %}
                                                {% if show_bit %}
                                                    <li>{% get_bit_label object.exclude_conditions forloop.counter0 %}</li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                </dd>
                                <dt>Languages Spoken</dt>
                                <dd id="languages-spoken-summary">
                                    {% if object.require_languages.mask == 0 %}
                                        <p>No required languages.</p>
                                    {% else %}
                                        Require:
                                        <ul>
                                            {% for bit in object.require_languages %}
                                                {% bit_is_set object.require_languages forloop.counter0 as show_bit %}
                                                {% if show_bit %}
                                                    <li>{% get_bit_label object.require_languages forloop.counter0 %}</li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                    {% if object.exclude_languages.mask == 0 %}
                                        <p>No excluded languages.</p>
                                    {% else %}
                                        Exclude:
                                        <ul>
                                            {% for bit in object.exclude_languages %}
                                                {% bit_is_set object.exclude_languages forloop.counter0 as show_bit %}
                                                {% if show_bit %}
                                                    <li>{% get_bit_label object.exclude_languages forloop.counter0 %}</li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                </dd>
                            </dl>
                        </div>
                        <h3>Define New Eligibility Criteria</h3>
                        <form method="POST" id="edit-participant-eligibility" class="well well-sm clearfix">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary btn-lg btn-block">Submit Proposed Changes</button>
                            <section class="form-group col-md-5">
                                <h4>
                                    Gestational Age at Birth
                                </h4>
                                <div id="gestational-age-range-specifier" class="range-specifier"></div>
                                <label for="gestational-age-include-na">
                                    <input id="gestational-age-include-na"
                                           name="gestational_age_include_na"
                                           type="checkbox"
                                           data-toggle="toggle"
                                           data-on="Include N/A"
                                           data-off="Exclude N/A"
                                           data-onstyle="success"
                                           data-offstyle="danger"
                                           data-size="mini"
                                           data-width="120"
                                           {% if object.gestational_age_include_na %}checked{% endif %}>
                                </label>
                            </section>
                            <section class="form-group col-md-push-1 col-md-6">{# Age Range -- slider #}
                                <h4>Age Range</h4>
                                <p class="help-block">
                                    Use text inputs to specify age range; using the slider as a visual aid.
                                </p>
                                <div id="age-range-specifier" class="range-specifier"></div>
                                <table id="age-range-details" class="table small">
                                    <thead>
                                        <tr>
                                            <th>Lower Bound</th>
                                            <th>Upper Bound</th>
                                            <th>Unit of Time</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <label for="age-range-start-years" class="sr-only">
                                                    Age range start in years
                                                </label>
                                                <input id="age-range-start-years"
                                                       class="form-control"
                                                       name="age_range_start_years"
                                                       type="number"
                                                       min=0
                                                       value={{ object.age_range_start_years }}>
                                            </td>
                                            <td>
                                                <label for="age-range-end-years" class="sr-only">
                                                    Age range end in years
                                                </label>
                                                <input id="age-range-end-years"
                                                       class="form-control"
                                                       name="age_range_end_years"
                                                       type="number"
                                                       min=0
                                                       value={{ object.age_range_end_years }}>
                                            </td>
                                            <td>
                                                Years
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <label for="age-range-start-months" class="sr-only">
                                                    Age range start in months
                                                </label>
                                                <input id="age-range-start-months"
                                                       class="form-control"
                                                       name="age_range_start_months"
                                                       type="number"
                                                       min=0
                                                       max=11
                                                       value={{ object.age_range_start_months }}>
                                            </td>
                                            <td>
                                                <label for="age-range-end-months" class="sr-only">
                                                    Age range start in months
                                                </label>
                                                <input id="age-range-end-months"
                                                       class="form-control"
                                                       name="age_range_end_months"
                                                       type="number"
                                                       min=0
                                                       max=11
                                                       value={{ object.age_range_end_months }}>
                                            </td>
                                            <td>Months</td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <label for="age-range-start-days" class="sr-only">
                                                    Age range start in days
                                                </label>
                                                <input id="age-range-start-days"
                                                       class="form-control"
                                                       name="age_range_start_days"
                                                       type="number"
                                                       min=0
                                                       max=30
                                                       value={{ object.age_range_start_days }}>
                                            </td>
                                            <td>
                                                <label for="age-range-end-days" class="sr-only">
                                                    Age range end in days
                                                </label>
                                                <input id="age-range-end-days"
                                                       class="form-control"
                                                       name="age_range_end_days"
                                                       type="number"
                                                       min=0
                                                       max=30
                                                       value={{ object.age_range_end_days }}>
                                            </td>
                                            <td>Days</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <em class="small help-block">
                                    * Families who select a child outside the age range see a warning indicating that
                                    their data may not be used. The child's age in days is compared to these (inclusive)
                                    min and max ages (computed as years * 365 + months * 30 + days) to check
                                    eligibility.
                                </em>
                            </section>
                            <section class="form-group col-md-12">{# Gender - quad button group #}
                                <h4>Gender Specification</h4>
                                <div class="debug-django-choices">
                                    {% for choice in object.gender_specification.choices %}
                                        {{ choice }}
                                    {% endfor %}
                                </div>
                                {% comment %}
                                The values below - na, 1, 2, 3, -  are defined in studies/fields.py, copied here for
                                clarity:

                                GENDER_OPTIONS = (
                                    (0, "na", _("Not answered")),
                                    (1, "o", _("Other")),
                                    (2, "m", _("Male")),
                                    (3, "f", _("Female")),
                                )
                                {% endcomment %}
                                <div id="gender-selector" class="btn-group btn-group-justified" data-toggle="buttons">
                                    <label class="btn btn-default {% if object.gender_specification == None %}active{% endif %}" for="does-not-matter">
                                        <input id="does-not-matter"
                                               name="gender_specification"
                                               type="radio"
                                               autocomplete="off"
                                               value=""
                                               {% if object.gender_specification == None %}checked{% endif %}>
                                        Doesn't Matter
                                    </label>
                                    <label class="btn btn-warning {% if object.gender_specification == 0 %}active{% endif %}" for="unspecified-only">
                                        <input id="unspecified-only"
                                               name="gender_specification"
                                               type="radio"
                                               autocomplete="off"
                                               value="0"
                                               {% if object.gender_specification == 0 %}checked{% endif %}>
                                        Unspecified Only
                                    </label>
                                    <label class="btn btn-primary {% if object.gender_specification == 1 %}active{% endif %}" for="other-only">
                                        <input id="other-only"
                                               name="gender_specification"
                                               type="radio"
                                               autocomplete="off"
                                               value="1"
                                               {% if object.gender_specification == 1 %}checked{% endif %}>
                                        Other Only
                                    </label>
                                    <label class="btn btn-primary {% if object.gender_specification == 2 %}active{% endif %}" for="male-only">
                                        <input id="male-only"
                                               name="gender_specification"
                                               type="radio"
                                               autocomplete="off"
                                               value="2"
                                               {% if object.gender_specification == 2 %}checked{% endif %}>
                                        Male Only
                                    </label>
                                    <label class="btn btn-primary {% if object.gender_specification == 3 %}active{% endif %}" for="female-only">
                                        <input id="female-only"
                                               name="gender_specification"
                                               type="radio"
                                               autocomplete="off"
                                               value="3"
                                               {% if object.gender_specification == 3 %}checked{% endif %}>
                                        Female Only
                                    </label>
                                </div>
                            </section>

                            {# Characteristics - custom set of button groups? #}
                            <section class="form-group col-md-6">
                                <h4>
                                    Characteristics
                                    <div id="control-all-conditions"
                                         class="btn-group btn-group-xs pull-right"
                                         role="group"
                                         aria-label="Toggle All Characteristics/Conditions">
                                        <button type="button" class="btn btn-danger" value="exclude-all">Exclude All</button>
                                        <button type="button" class="btn btn-default" value="reset-all">Reset</button>
                                        <button type="button" class="btn btn-success" value="require-all">Require All</button>
                                    </div>
                                </h4>
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th colspan=2>
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody id="characteristics-switch-table">
                                    {%  comment %}
                                        Not optimal to use the form fields as a proxy this way.
                                        Maybe we can directly reference the fields in the context object?
                                    {% endcomment %}
                                    {% for option in form.fields.require_conditions.choices %}
                                        {% bit_is_set object.require_conditions forloop.counter0 as required_bit %}
                                        {% bit_is_set object.exclude_conditions forloop.counter0 as excluded_bit %}
                                        <tr>
                                            <td>
                                                <div class="btn-group btn-group-xs" data-toggle="buttons">
                                                    <label class="btn btn-danger {% if excluded_bit %}active{% endif %}" for="exclude-{{ option.0 }}">
                                                        <input id="exclude-{{ option.0 }}"
                                                               class="exclusion"
                                                               name="exclude_conditions"
                                                               type="checkbox"
                                                               autocomplete="off"
                                                               value="{{ option.0 }}"
                                                               {% if excluded_bit %}checked{% endif %}>
                                                        Exclude
                                                    </label>
                                                    <label class="btn btn-default {% if not required_bit and not excluded_bit %}active{% endif %}"
                                                           for="unspecified-{{ option.0 }}">
                                                        <input id="unspecified-{{ option.0 }}"
                                                               type="checkbox"
                                                               autocomplete="off"
                                                               {% if not required_bit and not excluded_bit %}checked{% endif %}>
                                                        N/A
                                                    </label>
                                                    <label class="btn btn-success {% if required_bit %}active{% endif %}"
                                                           for="require-{{ option.0 }}">
                                                        <input id="require-{{ option.0 }}"
                                                               class="requirement"
                                                               name="require_conditions"
                                                               type="checkbox"
                                                               value="{{ option.0 }}"
                                                               autocomplete="off"
                                                               {% if required_bit %}checked{% endif %}>
                                                        Require
                                                    </label>
                                                </div>
                                            </td>
                                            <td class="small {% if required_bit %}bg-success{% elif excluded_bit %}bg-danger{% endif %}">{{ option.1 }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </section>

                            {# Languages Spoken - custom set of button groups? #}
                            <section class="form-group col-md-6">
                                <h4>
                                    Languages Spoken
                                    <div id="control-all-languages"
                                         class="btn-group btn-group-xs pull-right"
                                         role="group"
                                         aria-label="Toggle All Languages">
                                        <button type="button" class="btn btn-danger" value="exclude-all">Exclude All</button>
                                        <button type="button" class="btn btn-default" value="reset-all">Reset</button>
                                        <button type="button" class="btn btn-success" value="require-all">Require All</button>
                                    </div>
                                </h4>
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th colspan=2>

                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody id="languages-switch-table">
                                    {% for option in form.fields.require_languages.choices %}
                                        {% bit_is_set object.require_languages forloop.counter0 as required_bit %}
                                        {% bit_is_set object.exclude_languages forloop.counter0 as excluded_bit %}
                                        <tr>
                                            <td>
                                                <div class="btn-group btn-group-xs" data-toggle="buttons">
                                                    <label class="btn btn-danger {% if excluded_bit %}active{% endif %}" for="exclude-{{ option.0 }}">
                                                        <input id="exclude-{{ option.0 }}"
                                                               class="exclusion"
                                                               name="exclude_languages"
                                                               type="checkbox"
                                                               value="{{ option.0 }}"
                                                               autocomplete="off"
                                                               {% if excluded_bit %}checked{% endif %}>
                                                        Exclude
                                                    </label>
                                                    <label class="btn btn-default {% if not required_bit and not excluded_bit %}active{% endif %}"
                                                           for="unspecified-{{ option.0 }}">
                                                        <input id="unspecified-{{ option.0 }}"
                                                               type="radio"
                                                               autocomplete="off"
                                                               {% if not required_bit and not excluded_bit %}checked{% endif %}>
                                                        N/A
                                                    </label>
                                                    <label class="btn btn-success {% if required_bit %}active{% endif %}" for="require-{{ option.0 }}">
                                                        <input id="require-{{ option.0 }}"
                                                               class="requirement"
                                                               name="require_languages"
                                                               type="checkbox"
                                                               value="{{ option.0 }}"
                                                               autocomplete="off"
                                                               {% if required_bit %}checked{% endif %}>
                                                        Require
                                                    </label>
                                                </div>
                                            </td>
                                            <td class="small {% if required_bit %}bg-success{% elif excluded_bit %}bg-danger{% endif %}">{{ option.1 }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </section>
                            {# Hidden inputs #}
                            <input id="gestational-age-start"
                                   name="gestational_age_start"
                                   type="hidden"
                                   value="{{ object.gestational_age_start }}">
                            <input id="gestational-age-end"
                                   name="gestational_age_end"
                                   type="hidden"
                                   value="{{ object.gestational_age_end }}">
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {#  TODO: Once we have a static asset pipeline, move this out to a javascript file so we can defer it. #}
    <script type="text/javascript">
        /*----------------
         * Constants
         --------------- */
        const DATE_INPUT_MOMENT_FORMAT = 'YYYY-MM-DD',
              MOMENT_OF_PAGE_LOAD      = moment(),
              TWENTY_YEARS_AGO         = moment().subtract(20, 'year');

        /*----------------
         * Element handles.
         ---------------- */
        // Regular DOM
        const participantEligibilityForm   = document.getElementById('edit-participant-eligibility'),
              ageRangeSpecifier            = document.getElementById('age-range-specifier'),
              gestationalAgeRangeSpecifier = document.getElementById('gestational-age-range-specifier'),
              totalDaysInput               = document.getElementById('total-days'),
              characteristicSwitches       = document.getElementById('characteristics-switch-table'),
              languageSwitches             = document.getElementById('languages-switch-table'),
              gestationalAgeStartInput     = document.getElementById('gestational-age-start'),
              gestationalAgeEndInput       = document.getElementById('gestational-age-end'),
              ageRangeDetailsContainer     = document.getElementById('age-range-details'),
              ageRangeStartYearsInput      = document.getElementById('age-range-start-years'),
              ageRangeStartMonthsInput     = document.getElementById('age-range-start-months'),
              ageRangeStartDaysInput       = document.getElementById('age-range-start-days'),
              ageRangeEndYearsInput        = document.getElementById('age-range-end-years'),
              ageRangeEndMonthsInput       = document.getElementById('age-range-end-months'),
              ageRangeEndDaysInput         = document.getElementById('age-range-end-days'),
              globalConditionControl       = document.getElementById('control-all-conditions'),
              globalLanguageControl        = document.getElementById('control-all-languages');


        /* ----------------
         * Options objects.
         ---------------- */
        const EX_UTERO_AGE_VALUE_FORMATTER = {
            to(floatNumber) {
                let days = Math.round(floatNumber),
                    duration = moment.duration(days, 'days');
                return `<span class="small">${duration.years()} years,<br />
                        ${duration.months()} months, <br />
                        ${duration.days()} days</span>`;
            },
        };

        const HUMANIZE_AGE_FORMATTER = {
            to(floatNumber) {
                let days = Math.round(floatNumber),
                    duration = moment.duration(days, 'days');
                return `<p class="tiny-ticks">${duration.humanize()}</p>`;
            },
        };

        const AGE_RANGE_SLIDER_OPTIONS = {
            start: [30 * 4, 365],  // Defaults.
            step: 1,
            behaviour: 'drag',
            connect: true,
            tooltips: [EX_UTERO_AGE_VALUE_FORMATTER, EX_UTERO_AGE_VALUE_FORMATTER],
            range: {
                min: 0,
                '30%': 365,
                '60%': 365 * 3,
                max: MOMENT_OF_PAGE_LOAD.diff(TWENTY_YEARS_AGO, 'days'),  // Account for leap years, etc.
            },
            pips: {
                mode: 'positions',
                values: [0, 30, 60, 100],
                density: 4,
                format: HUMANIZE_AGE_FORMATTER
            }
        };

        const GESTATIONAL_AGE_STRING_TO_ENUM_INT = {
            "Under 24 weeks": 0,
            "24 weeks": 1,
            "25 weeks": 2,
            "26 weeks": 3,
            "27 weeks": 4,
            "28 weeks": 5,
            "29 weeks": 6,
            "30 weeks": 7,
            "31 weeks": 8,
            "32 weeks": 9,
            "33 weeks": 10,
            "34 weeks": 11,
            "35 weeks": 12,
            "36 weeks": 13,
            "37 weeks": 14,
            "38 weeks": 15,
            "39 weeks": 16,
            "40 or more weeks": 17,
        };

        const GESTATIONAL_AGE_ENUM_INT_TO_STRING = invertObject(GESTATIONAL_AGE_STRING_TO_ENUM_INT);

        const GESTATIONAL_AGE_VALUE_FORMATTER = {
            to: numericValue => GESTATIONAL_AGE_ENUM_INT_TO_STRING[Math.round(numericValue)],
            // 'from' the formatted value.
            // Receives a string, should return a number.
            from: stringValue => GESTATIONAL_AGE_STRING_TO_ENUM_INT[stringValue],
        };

        // Regular weeks, easier
        const GESTATIONAL_AGE_RANGE_SLIDER_OPTIONS = {
            start: [12, 17],
            behaviour: 'drag',
            step: 1,
            connect: true,
            range: {
                "min": [0],
                "max": [17],
            },
            orientation: 'vertical',
            direction: 'rtl',
            tooltips: [GESTATIONAL_AGE_VALUE_FORMATTER, GESTATIONAL_AGE_VALUE_FORMATTER],
            pips: {
                mode: 'values',
                density: 1,
                stepped: true,
                values: [0, 12, 17],
                format: GESTATIONAL_AGE_VALUE_FORMATTER
            },
        };

        /* -----------------
         * Helper functions.
         ----------------- */
        function invertObject(json) {
            let ret = {};
            for (let key in json) {
                ret[json[key]] = key;
            }
            return ret;
        }


        /* ------------------------
         * Event Handler functions.
         ------------------------ */


        /**
         * Creates an event listener that flips all the bits on a table of tri-state elements.
         *
         * @param tableBodyElement
         * @return {Function}
         */
        function createGlobalSwitchHandler(tableBodyElement) {
            /**
             * This will be an event listener on a control-all-* button group element.
             */
            return (event) => {
                let target = event.target;

                if (target.tagName === 'BUTTON') { // Manual event delegation
                    // 1) Figure out what action to take
                    let action                     = target.value,
                        // a. "Query selector fragment" just a convenient way to parsimoniously target elements.
                        inputQuerySelectorFragment = action === 'exclude-all' ? '.exclusion'
                                                   : action === 'require-all' ? '.requirement'
                                                   : ':not(.exclusion):not(.requirement)';

                    // 2) Make appropriate labels active
                    tableBodyElement.querySelectorAll(`input${inputQuerySelectorFragment}`).forEach(input => {
                        let labelElement = input.parentElement;
                        // XXX: optimizing for clarity here rather than efficiency, since we have very few elements.
                        handleLabelSelectionForTristateComponent(labelElement);
                        labelElement.classList.add('active'); // we're not clicking directly so we have to add active.
                    });
                }
            }
        }

        /**
         * Save age range slider states into the numeric inputs directly below.
         */
        function loadAgeRangeSliderStatesIntoNumericInputs(event) {
            let [ageRangeStartInDays, ageRangeEndInDays] = ageRangeSpecifier.noUiSlider.get().map(d => parseInt(d));

            let ageRangeStartMoment = moment.duration(ageRangeStartInDays, 'days'),
                ageRangeEndMoment   = moment.duration(ageRangeEndInDays, 'days');

            ageRangeStartYearsInput.value  = ageRangeStartMoment.years();
            ageRangeStartMonthsInput.value = ageRangeStartMoment.months();
            ageRangeStartDaysInput.value   = ageRangeStartMoment.days();

            ageRangeEndYearsInput.value    = ageRangeEndMoment.years();
            ageRangeEndMonthsInput.value   = ageRangeEndMoment.months();
            ageRangeEndDaysInput.value     = ageRangeEndMoment.days();
        }

        /**
         * Save the gestational age range slider state into the hidden fields.
         */
        function loadGestationalAgeRangeSliderStateIntoHiddenInputs(event) {
            let [gestationalAgeStart, gestationalAgeEnd] = gestationalAgeRangeSpecifier.noUiSlider.get();

            gestationalAgeStartInput.value = parseInt(gestationalAgeStart);
            gestationalAgeEndInput.value   = parseInt(gestationalAgeEnd);
        }

        /**
         * Add requisite data to form from the rest of the fields.
         */
        function onFormSubmit(event) {
            let form = this;

            event.preventDefault();

            form.submit();
        }

        function handleLabelSelectionForTristateComponent(labelElement) {
            let buttonGroup = labelElement.parentElement,
                requireInput = buttonGroup.querySelector('input.requirement'),
                excludeInput = buttonGroup.querySelector('input.exclusion'),
                unspecifiedInput = buttonGroup.querySelector('input:not(.requirement):not(.exclusion)'),
                buttonClasses = labelElement.children[0].classList,
                labelCell = buttonGroup.parentElement.parentElement.children[1];

            // Removing the active class before checking induces radio-button like behavior by tricking bootstrap's
            // data-toggle behavior into thinking this is the first time something's been checked.
            [requireInput, excludeInput, unspecifiedInput]
                .forEach(input => input.parentElement.classList.remove('active'));

            switch (buttonClasses.value) {
                case 'requirement':
                    requireInput.checked = true;
                    excludeInput.checked = false;
                    unspecifiedInput.checked = false;

                    labelCell.classList.add('bg-success');
                    labelCell.classList.remove('bg-danger');
                    break;
                case 'exclusion':
                    requireInput.checked = false;
                    excludeInput.checked = true;
                    unspecifiedInput.checked = false;

                    labelCell.classList.add('bg-danger');
                    labelCell.classList.remove('bg-success');
                    break;
                default:  // Unspecified
                    requireInput.checked = false;
                    excludeInput.checked = false;
                    unspecifiedInput.checked = true;

                    labelCell.classList.remove('bg-danger');
                    labelCell.classList.remove('bg-success');
                    break;
            }
        }

        /**
         * This function exists to allow type=checkbox inputs across characteristic and language switches so that we can
         * use a singular name label for bitfield inputs (e.g. "include_languages") to gather all the
         * language/characteristic choices into a single list for sensible FormData structure, while enforcing
         * radio button-like behavior within the individual switch (i.e., don't allow the user to both include and
         * exclude a given language/characteristic).
         */
        function handleTristateSelection(event) {

            // We really have to hand-hold here since browsers don't actually have a native understanding of tri-state
            // components, much less an array thereof.
            let target = event.target;

            if (target.tagName === 'LABEL') { // Manual event delegation
                handleLabelSelectionForTristateComponent(target);
            }
        }


        function synchronizeAgeRangeSliderWithNumericInputChanges() {
            let ageRangeStartInDays = moment.duration({
                years: parseInt(ageRangeStartYearsInput.value),
                months: parseInt(ageRangeStartMonthsInput.value),
                days: parseInt(ageRangeStartDaysInput.value),
            }).asDays();

            let ageRangeEndInDays = moment.duration({
                years: parseInt(ageRangeEndYearsInput.value),
                months: parseInt(ageRangeEndMonthsInput.value),
                days: parseInt(ageRangeEndDaysInput.value),
            }).asDays();

            if (!(ageRangeStartInDays < ageRangeEndInDays)) {
                // Set to bottom bound.
                ageRangeEndInDays = ageRangeStartInDays;
                ageRangeEndYearsInput.value  = ageRangeStartYearsInput.value;
                ageRangeEndMonthsInput.value = ageRangeStartMonthsInput.value;
                ageRangeEndDaysInput.value   = ageRangeStartDaysInput.value;
            }

            ageRangeSpecifier.noUiSlider.set([ageRangeStartInDays, ageRangeEndInDays]);
        }

        function synchronizeGestationalAgeRangeSliderWithHiddenInputs() {
            gestationalAgeRangeSpecifier.noUiSlider.set(
                [
                    parseInt(gestationalAgeStartInput.value),
                    parseInt(gestationalAgeEndInput.value)
                ]
            );
        }

        /* ------------------------
         * Initialization procedures.
         ------------------------ */
        function loadInitialState() {
            // Age Range Inputs
            synchronizeAgeRangeSliderWithNumericInputChanges();

            // Gestational Age Inputs
            synchronizeGestationalAgeRangeSliderWithHiddenInputs();
        }

        function initializeComponents() {
            noUiSlider.create(
                ageRangeSpecifier,
                AGE_RANGE_SLIDER_OPTIONS
            );

            ageRangeSpecifier.setAttribute('disabled', true);

            noUiSlider.create(
                gestationalAgeRangeSpecifier,
                GESTATIONAL_AGE_RANGE_SLIDER_OPTIONS
            );

            gestationalAgeRangeSpecifier.noUiSlider
                .on('change', loadGestationalAgeRangeSliderStateIntoHiddenInputs);
            ageRangeSpecifier.noUiSlider
                .on('change', loadAgeRangeSliderStatesIntoNumericInputs);

            // No need for two-way sync with gestational age, since there's no visible input component.
            ageRangeDetailsContainer.addEventListener('change', synchronizeAgeRangeSliderWithNumericInputChanges);

            characteristicSwitches.addEventListener('click', handleTristateSelection);

            languageSwitches.addEventListener('click', handleTristateSelection);

            participantEligibilityForm.addEventListener('submit', onFormSubmit);

            globalConditionControl.addEventListener('click', createGlobalSwitchHandler(characteristicSwitches));
            globalLanguageControl.addEventListener('click', createGlobalSwitchHandler(languageSwitches));
        }

        function initializeView() {
            initializeComponents();
            loadInitialState();
        }

        initializeView();
    </script>
{% endblock %}
