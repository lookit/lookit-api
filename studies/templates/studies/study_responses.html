{% extends "exp/base.html" %}
{% load django_bootstrap5 %}
{% load bootstrap_icons %}
{% load exp_extras %}
{% load web_extras %}
{% load tz %}
{% load static %}
{% block title %}
    Responses | {{ study.name }}
{% endblock title %}
{% block head %}
    {{ block.super }}
    <script src="{% static 'js/table-date-filter.js' %}"
            type="application/javascript"
            defer></script>
    <script src="{% static 'js/study-responses.js' %}"
            type="application/javascript"
            defer></script>
{% endblock head %}
{% block breadcrumb %}
    <nav aria-label="breadcrumb" class="my-2">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{% url 'exp:study-list' %}">Manage Studies</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'exp:study' pk=study.id %}">{{ study.name }}</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Individual Responses</li>
        </ol>
    </nav>
{% endblock breadcrumb %}
{% block content %}
    {% button_primary_classes as btn_primary_classes %}
    {% button_primary_classes "float-end my-3" as btn_primary_classes_create %}
    {% page_title "Individual Responses" %}
    <div class="row">
        <div class="col">{% include "studies/_response_nav_tabs.html" with active="individual" %}</div>
    </div>
    <div class="row my-4">
        <div class="col">
            <p>
                Data about
                {{ summary_statistics.responses.accepted }}
                {{ summary_statistics.responses.accepted|pluralize:"response is,responses are" }}
                available.
                {{ summary_statistics.responses.pending }}
                additional
                {{ summary_statistics.responses.pending|pluralize:"response,responses" }}
                awaiting consent judgement;
                {{ summary_statistics.responses.rejected }}
                {{ summary_statistics.responses.rejected|pluralize:"consent,consents" }}
                rejected.
            </p>
            <p>
                <a href="{% url 'exp:study-responses-consent-manager' pk=study.pk %}">Go to consent manager</a>
            </p>
        </div>
        <div class="col">
            <div class="card bg-light">
                <div class="card-body">
                    <div>
                        Selected response <span class="short-child-id"></span> (<span class="response-date"></span>).
                    </div>
                    <div>
                        <div class="truncate-parent-feedback">
                            <span class="fw-bold">Parent/guardian feedback:</span>
                            <span class="parent-feedback"></span>
                        </div>
                    </div>
                    <a rel="noopener noreferrer"
                       target="_blank"
                       class="contact-family"
                       href="{% url "exp:study-participant-contact" study.id %}">Send a message to this family (<span class="parent-id"></span>)</a>
                </div>
            </div>
        </div>
    </div>
    {% if response_data %}
        <div class="row my-4">
            <div class="col">
                <div class="card">
                    <div class="card-body table-responsive">
                        <input type="hidden"
                               id="csrftokenurl"
                               name="csrfmiddlewaretoken"
                               value="{{ csrf_token }}"
                               data-update-url="{% url 'exp:study-responses-researcher-update' pk=study.id %}" />
                        <table id="individualResponsesTable" class="table">
                            <caption class="d-none">Study Responses</caption>
                            <thead>
                                <tr>
                                    <th scope="col"></th>
                                    <th scope="col">Child ID</th>
                                    <th scope="col">Response ID</th>
                                    <th scope="col">Date UTC</th>
                                    <th scope="col">Time Elapsed</th>
                                    <th scope="col">
                                        Exit Frame
                                        <br>
                                        Status
                                    </th>
                                    <th scope="col">
                                        Payment
                                        <br>
                                        Status
                                    </th>
                                    <th scope="col">
                                        Session
                                        <br>
                                        Status
                                    </th>
                                    <th scope="col">Star</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for response in response_data %}
                                    <tr class="selectable-response {% if response.response__is_preview %}preview-row{% endif %}"
                                        id="response-{{ forloop.counter }}"
                                        data-response-id="{{ response.response__id }}"
                                        data-response-uuid="{{ response.response__uuid }}">
                                        <td>
                                            {% if response.response__is_preview %}P{% endif %}
                                        </td>
                                        <td>{{ response.child_id_slug }}</td>
                                        <td>{{ response.response__id }}</td>
                                        <td>
                                            {# "This turns off the converstion from UTC to the project TIME_ZONE (America/NY). #}
                                            {% localtime off %}
                                                {{ response.response__date_created|date:"n/j/Y g:i A"|default:"N/A" }}
                                            {% endlocaltime %}
                                        </td>
                                        <td>{{ response.response__date_created|timesince }}</td>
                                        <td>
                                            {% if response.response__completed %}
                                                Complete
                                            {% else %}
                                                Incomplete
                                            {% endif %}
                                        </td>
                                        <td>
                                            <select name="payment-status"
                                                    id="payment-status-{{ forloop.counter }}"
                                                    class="researcher-editable form-select"
                                                    autocomplete="off"
                                                    aria-label="Set optional payment status for this response">
                                                {% for pstatus in payment_status_options %}
                                                    <option value="{{ pstatus.0 }}"
                                                            {% if response.response__researcher_payment_status == pstatus.1 %}selected{% endif %}>
                                                        {{ pstatus.1 }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <select name="session-status"
                                                    id="session-status-{{ forloop.counter }}"
                                                    class="researcher-editable form-select"
                                                    autocomplete="off"
                                                    aria-label="Set optional session status for this response">
                                                {% for sstatus in session_status_options %}
                                                    <option value="{{ sstatus.0 }}"
                                                            {% if response.response__researcher_session_status == sstatus.1 %}selected{% endif %}>
                                                        {{ sstatus.1 }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <input type="checkbox"
                                                   name="star"
                                                   id="star-checkbox-{{ forloop.counter }}"
                                                   class="researcher-editable input-checkbox-hidden star-checkbox"
                                                   aria-label="Toggle optional Star selection for this response" />
                                            <label for="star-checkbox-{{ forloop.counter }}">
                                                {% if response.response__researcher_star %}
                                                    {% bs_icon "star" extra_classes="icon-star icon-hidden" size='1.5em' %}{% bs_icon "star-fill" extra_classes="icon-star icon-star-filled" size='1.5em' %}
                                                {% else %}
                                                    {% bs_icon "star" extra_classes="icon-star" size='1.5em' %}{% bs_icon "star-fill" extra_classes="icon-star icon-star-filled icon-hidden" size='1.5em' %}
                                                {% endif %}
                                            </label>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th scope="col"></th>
                                    <th scope="col">
                                        <input type="text" class="form-control" placeholder="Filter Child ID" />
                                    </th>
                                    <th scope="col">
                                        <input type="text" class="form-control" placeholder="Filter Response ID" />
                                    </th>
                                    <th scope="col">
                                        <input type="text"
                                               id="dateRangeFilter"
                                               class="form-control"
                                               name="daterange" />
                                    </th>
                                    <th scope="col">
                                        <input type="text"
                                               class="form-control"
                                               placeholder="Filter Time Elapsed" />
                                    </th>
                                    <th scope="col">
                                        <input type="text"
                                               class="form-control"
                                               placeholder="Filter Exit Frame Status" />
                                    </th>
                                    <th scope="col">
                                        <input type="text" class="form-control" placeholder="Filter Payment Status" />
                                    </th>
                                    <th scope="col">
                                        <input type="text" class="form-control" placeholder="Filter Session Status" />
                                    </th>
                                    <th scope="col">
                                        <input type="text" class="form-control" placeholder="Filter Star" />
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                        {% if can_view_regular_responses and not can_view_preview_responses %}
                            <p class="text-center">
                                <em>Based on your permissions, no preview responses are shown.</em>
                            </p>
                        {% endif %}
                        {% if not can_view_regular_responses and can_view_preview_responses %}
                            <p class="text-center">
                                <em>Based on your permissions, only preview responses are shown.</em>
                            </p>
                        {% endif %}
                        {% if not can_view_regular_responses and not can_view_preview_responses %}
                            <p class="text-center">
                                <em>You do not have permission to view responses.</em>
                            </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="row my-4">
            <div class="col">
                {% if study.show_videos %}
                    <div class="card bg-light my-4">
                        <div class="card-body">
                            <h5 class="card-title">Download videos</h5>
                            <p class="card-text fst-italic text-muted mt-2">
                                <em class="my-2">Video recordings usually become available for download after a few minutes, but may take as long as 24 hours to appear.
                                    <br>
                                    <br>
                                Note: In rare cases, video uploads can be damaged or lost, e.g. because the participant left the study early, there was an internet connection problem, etc. We automatically attempt to restore any incomplete video files that reach the servers. If video files do not appear here after 24 hours, they unfortunately can't be recovered.</em>
                            </p>
                            {% for response in response_data %}
                                <div class="response-attachments"
                                     id="resp-attachment-{{ forloop.counter }}"
                                     style="display:none">
                                    {% for video in response.videos %}
                                        <div class="row pt-1">
                                            <div class="col-12 col-md-8">{{ video.display_name|wordwrap:45 }}</div>
                                            <div class="col-12 col-md-4">
                                                <a target="_blank"
                                                   rel="noreferrer noopener"
                                                   href="{% url 'exp:study-response-video-download' pk=study.id video=video.pk %}?mode=view"
                                                   class="{% button_primary_classes %} btn-sm">View</a>
                                                <a href="{% url 'exp:study-response-video-download' pk=study.id video=video.pk %}?mode=download"
                                                   class="{% button_primary_classes %} btn-sm">Download</a>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                <form class="download"
                      method="get"
                      action="{% url 'exp:study-responses-single-download' pk=study.pk %}">
                    {% csrf_token %}
                    <div class="card bg-light my-4">
                        <div class="card-body">
                            <input type="hidden" name="response_id" />
                            <h5 class="card-title">Download response</h5>
                            <p class="card-text">Include with response download:</p>
                            <div class="two-column-list mb-3">{% include "studies/_data_options.html" with data_options=data_options %}</div>
                            <p class="card-text">
                                <label for="data-type-selector">Data Type</label>
                            </p>
                            <div class="input-group">
                                <select class="form-select"
                                        id="data-type-selector"
                                        name="data-type-selector"
                                        aria-label="Select data type">
                                    <option value="json">JSON</option>
                                    <option value="csv">CSV summary</option>
                                    <option value="framedata">CSV frame data</option>
                                </select>
                                <span class="input-group-btn">
                                    {% bootstrap_button "Download response" button_type="submit" button_class=btn_primary_classes name="download-individual-data" %}
                                </span>
                            </div>
                        </div>
                    </div>
                </form>
                <div class="card bg-light my-4">
                    <div class="card-body">
                        {% if can_edit_feedback %}
                            <form class="feedback"
                                  method="post"
                                  action="{% url 'exp:study-response-submit-feedback' pk=study.id %}">
                                {% csrf_token %}
                                <h5 class="card-title">Give new feedback</h5>
                                <section class="form-group">
                                    <label class="visually-hidden" for="response-feedback">Response feedback:</label>
                                    <textarea id="response-feedback"
                                              class="form-control"
                                              name="comment"
                                              placeholder="Give feedback directly to the family/child here. This feedback will appear alongside the other session information in the family's study history."
                                              rows="4"
                                              cols="50"></textarea>
                                    <input type="hidden" name="response_id" />
                                    {% bootstrap_button "Create" button_type="submit" button_class=btn_primary_classes_create %}
                                    <br />
                                </section>
                            </form>
                        {% endif %}
                        <section class="my-3">
                            <h5 class="card-title">Existing feedback</h5>
                            {% for response in response_list %}
                                <div id="feedback-list-for-{{ response.id }}" class="feedback-list">
                                    {% for feedback in response.feedback.all %}
                                        {% if can_edit_feedback %}
                                            <form method="post"
                                                  class="small"
                                                  action="{% url 'exp:study-response-submit-feedback' pk=study.id %}">
                                                {% csrf_token %}
                                                <div class="form-group">
                                                    <label class="visually-hidden" for="feedback-edit-{{ feedback.id }}">
                                                        <strong>Edit Feedback</strong>
                                                    </label>
                                                    <textarea id="feedback-edit-{{ feedback.id }}"
                                                              class="form-control"
                                                              name="comment"
                                                              rows="2"
                                                              cols="50">{{ feedback.comment }}</textarea>
                                                    <input type="hidden" name="feedback_id" value="{{ feedback.id }}" />
                                                    {% bootstrap_button "Update" button_type="submit" button_class="btn btn-warning float-end mt-3" %}
                                                    <footer class="py-2">
                                                        Added by: {{ feedback.researcher.get_full_name }}
                                                    </footer>
                                                </div>
                                            </form>
                                        {% else %}
                                            <p class="card-text">{{ feedback.comment }}</p>
                                            <footer class="py-2">
                                                {{ feedback.researcher.get_full_name }}
                                            </footer>
                                        {% endif %}
                                    {% empty %}
                                        <div class="empty-text">No feedback</div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </section>
                    </div>
                </div>
            </div>
            <div class="col">
                {% for response in response_data %}
                    <div class="card bg-light my-4 response-summary"
                         id="response-summary-{{ forloop.counter }}"
                         style="display:none">
                        <div class="card-body">
                            <h5 class="card-title">Response details</h5>
                            <table class="table table-sm table-hover response-details">
                                <caption class="visually-hidden">Response Details</caption>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for pair in response.summary %}
                                        <tr class="{% if pair.name == 'Video privacy level' %} {% if pair.value == 'public' %} list-group-item-success {% elif pair.value == 'scientific' %} list-group-item-warning {% else %} list-group-item-danger {% endif %} {% endif %}">
                                            <td tabindex="0" title="{{ pair.description }}">{{ pair.name }}</td>
                                        <td>{{ pair.value }}{% if pair.name == 'Date created' %} UTC{% endif %}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% else %}
        <div class="empty-text">No responses with confirmed consent.</div>
    {% endif %}
{% endblock content %}
