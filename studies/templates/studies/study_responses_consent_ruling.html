{% extends "exp/base.html" %}
{% load django_bootstrap5 %}
{% load bootstrap_icons %}
{% load static %}
{% block title %}
    Responses | {{ study.name }}
{% endblock title %}
{% block head %}
    {{ block.super }}
    <script type="application/json" id="response-key-value-store">
        {% comment %}
            When we upgrade to django 2.x, please convert to json_script. Please see:
            https://docs.djangoproject.com/en/2.1/ref/templates/builtins/#json-script
        {% endcomment %}
        {{ response_key_value_store | safe }}
    </script>
    <script src="{% static "studies/js/study-responses-consent-ruling.js" %}" defer></script>
{% endblock head %}
{% block content %}
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-light p-2">
            <li class="breadcrumb-item">
                <a href="{% url 'exp:study-list' %}">Manage Studies</a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'exp:study-detail' pk=study.id %}">{{ study.name }}</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Consent Manager</li>
        </ol>
    </nav>
    <h1>Consent Manager</h1>
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header">Responses</div>
                <div class="card-body">
                    <label for="response-status-filters">Show Currently ...</label>
                    <select id="response-status-filters"
                            name="response-status-filters"
                            class="form-control">
                        <option id="filter-pending" value="pending">
                            Pending
                        </option>
                        <option id="filter-accepted" value="accepted">
                            Accepted
                        </option>
                        <option id="filter-rejected" value="rejected">
                            Rejected
                        </option>
                    </select>
                    Responses*
                    <br />
                    <p class="help small">
                        <em>*Responses with approvals older than 3 weeks are not shown.</em>
                    </p>
                </div>
                <ul id="list-of-responses"
                    class="list-group rounded-0"
                    style="max-height:300px;
                           overflow-y: scroll;">
                    {% for response in loaded_responses %}
                        <li id="response-option-{{ response.uuid }}"
                            class="border-start-0 border-end-0 response-option list-group-item {{ response.current_ruling }} {% if response.is_preview %} preview-row{% endif %}"
                            data-id="{{ response.uuid }}"
                            data-original-status="{{ response.current_ruling }}">
                            <span>
                                <strong>{{ response.date_created | date:"D M d, P e" }}</strong>
                                {% if response.is_preview %}
                                    <p>
                                        <strong>[Preview]</strong>
                                    </p>
                                {% endif %}
                                <p>
                                    <em class="small">{{ response.ruling_comments }}</em>
                                </p>
                            </span>
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle"
                                        type="button"
                                        id="consentJudgementDropdown"
                                        data-bs-toggle="dropdown"
                                        aria-expanded="false">
                                    {{ response.current_ruling }}
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="consentJudgementDropdown">
                                    <li>
                                        <button class="consent-judgment dropdown-item"
                                                data-action="reset"
                                                style="display:none;">Undo</button>
                                    </li>
                                    {% if response.current_ruling != 'pending' %}
                                        <li>
                                            <button class="consent-judgment dropdown-item" data-action="pending">Revert to Pending</button>
                                        </li>
                                    {% endif %}
                                    {% if response.current_ruling != 'accepted' %}
                                        <li>
                                            <button class="consent-judgment dropdown-item" data-action="accepted">Accept</button>
                                        </li>
                                    {% endif %}
                                    {% if response.current_ruling != 'rejected' %}
                                        <li>
                                            <button class="consent-judgment dropdown-item" data-action="rejected">Reject</button>
                                        </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
                <form id="consent-ruling-form"
                      class="panel-footer clearfix m-2"
                      method="post">
                    {% csrf_token %}
                    <div class="d-grid gap-2 col-11 mx-auto">
                        <div class="text-center">
                            <button class="btn btn-warning btn-sm">
                                Revert to Pending <span class="pending-count badge">0</span>
                            </button>
                            <button class="btn btn-success btn-sm">
                                Approvals <span class="approvals-count badge">0</span>
                            </button>
                            <button class="btn btn-danger btn-sm">
                                Rejections <span class="rejections-count badge">0</span>
                            </button>
                        </div>
                        <input name="comments" type="hidden" value="{}"/>
                        <button type="submit" class="btn btn-primary">Submit Rulings & Comments {% bs_icon "send" %}</button>
                        <button id="reset-choices" type="button" class="btn btn-secondary">
                            Reset Current Choices {% bs_icon "repeat" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="col">
            <div class="card">
                <div class="card-body">
                    {# Basic video information/warnings go in below div #}
                    <div id="current-video-information" class="panel-body"></div>
                </div>
            </div>
            <video controls id="video-under-consideration" height="270" width="360">
                <source src="" type="video/mp4"/>
            </video>
            <textarea id="response-commentary"
                      class="form-control"
                      placeholder="Comment on session. These will be saved upon submit."></textarea>
            <div class="btn-toolbar d-flex justify-content-center m-2"
                 id="video-manager">
                <nav aria-label="Video navigation">
                    <ul class="pagination">
                        <li id="nav-video-previous">
                            <a aria-label="Previous" class="page-link">
                                <span aria-hidden="true">{% bs_icon "chevron-double-left" %}</span>
                            </a>
                        </li>
                        {# list items go here#}
                        <li id="nav-video-next">
                            <a aria-label="Next" class="page-link">
                                <span aria-hidden="true">{% bs_icon "chevron-double-right" %}</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
        <div class="col">
            <div class="card">
                <div class="card-header">Response Statistics</div>
                <div class="card-body">
                    <ul class="list-group">
                        <li class="list-group-item list-group-item-warning d-flex justify-content-between align-items-center">
                            <div class="fw-bold">Pending Responses</div>
                            <span class="badge bg-secondary rounded-pill">{{ summary_statistics.responses.pending }}</span>
                        </li>
                        <li class="list-group-item list-group-item-success d-flex justify-content-between align-items-center">
                            <div class="me-auto">
                                <div class="fw-bold">
                                    Accepted Responses
                                </div>
                                <div class="small">
                                    Unique Children
                                </div>
                            </div>
                            <span class="badge bg-secondary rounded-pill">{{ summary_statistics.responses.accepted }} / {{ summary_statistics.children.with_accepted_responses }}</span>
                        </li>
                        <li class="list-group-item list-group-item-danger d-flex justify-content-between align-items-center">
                            <div class="me-auto">
                                <div class="fw-bold">
                                    Rejected Responses
                                </div>
                                <div class="small">
                                    Children with no accepted responses
                                </div>
                            </div>
                            <span class="badge bg-secondary rounded-pill">{{ summary_statistics.responses.rejected }} / {{ summary_statistics.children.without_accepted_responses }}</span>
                        </li>
                    </ul>
                    <ul class="list-group my-3">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Total # Responses
                            <span class="badge bg-secondary rounded-pill">{{ summary_statistics.responses.total }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Total # Children
                            <span class="badge bg-secondary rounded-pill">{{ summary_statistics.children.total }}</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div id="response-info-container" class="card bg-light my-3">
        <div class="card-body">
            <h2 class="card-title">
                Session Data
            </h2>
            <table id="participant" class="table caption-top">
                <caption class="h3">Account Information</caption>
                <thead>
                    <tr>
                        <th>
                            ID
                        </th>
                        <th>
                            Global ID
                        </th>
                        <th>
                            Parent name
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        {# Participant data inserted here #}
                    </tr>
                </tbody>
            </table>
            <table id="child" class="table caption-top">
                <caption class="h3">  Child Information</caption>
                <thead>
                    <tr>
                        <th>
                            ID
                        </th>
                        <th>
                            Global ID
                        </th>
                        <th>
                            Name
                        </th>
                        <th>
                            Birthday
                        </th>
                        <th>
                            Gender
                        </th>
                        <th>
                            Additional Info
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        {# Child data inserted here #}
                    </tr>
                </tbody>
            </table>
            <table id="general" class="table caption-top">
                <caption class="h3">    Response Information</caption>
                <thead>
                    <tr>
                        <th>
                            Uuid
                        </th>
                        <th>
                            Global Event Timings
                        </th>
                        <th>
                            Sequence
                        </th>
                        <th>
                            Completed
                        </th>
                        <th>
                            Date Created
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        {# General data inserted here #}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
{% endblock content %}
